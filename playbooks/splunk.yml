---
- name: Install and start Splunk Enterprise
  hosts: splunk
  become: true
  gather_facts: true

  vars:
    splunk_url: "https://download.splunk.com/products/splunk/releases/latest/linux/splunk-latest-Linux-x86_64.tgz"
    splunk_install_dir: "/opt"
    splunk_home: "/opt/splunk"
    splunk_user: "splunk"
    splunk_group: "splunk"

  pre_tasks:
    - name: Fail if splunk_admin_password not provided
      ansible.builtin.assert:
        that:
          - splunk_admin_password is defined
          - splunk_admin_password | length >= 8
        fail_msg: "Provide -e splunk_admin_password=<password> (min 8 chars)."

  tasks:
    - name: Install prerequisite packages
      ansible.builtin.apt:
        name:
          - tar
          - gzip
          - wget
          - curl
        update_cache: true
        state: present
      when: ansible_os_family == "Debian"

    - name: Ensure splunk group exists
      ansible.builtin.group:
        name: "{{ splunk_group }}"
        state: present

    - name: Ensure splunk user exists
      ansible.builtin.user:
        name: "{{ splunk_user }}"
        group: "{{ splunk_group }}"
        shell: /bin/bash
        create_home: true
        system: true

    # ğŸ”¥ THIS IS THE CRITICAL FIX ğŸ”¥
    - name: Download Splunk (latest) with User-Agent
      ansible.builtin.get_url:
        url: "{{ splunk_url }}"
        dest: /tmp/splunk.tgz
        mode: '0644'
        headers:
          User-Agent: "Mozilla/5.0 (X11; Linux x86_64)"

    - name: Extract Splunk
      ansible.builtin.unarchive:
        src: /tmp/splunk.tgz
        dest: "{{ splunk_install_dir }}"
        remote_src: true
        creates: "{{ splunk_home }}/bin/splunk"

    - name: Set ownership
      ansible.builtin.file:
        path: "{{ splunk_home }}"
        owner: "{{ splunk_user }}"
        group: "{{ splunk_group }}"
        recurse: true

    - name: Start Splunk and accept license
      become_user: "{{ splunk_user }}"
      ansible.builtin.command: >
        {{ splunk_home }}/bin/splunk start
        --accept-license
        --answer-yes
        --no-prompt
        --seed-passwd {{ splunk_admin_password }}
      register: splunk_start
      changed_when: "'Started' in (splunk_start.stdout + splunk_start.stderr)"

    - name: Enable Splunk boot-start
      ansible.builtin.command:
        cmd: "{{ splunk_home }}/bin/splunk enable boot-start -user {{ splunk_user }} --accept-license --answer-yes --no-prompt"
      failed_when: false

    - name: Verify Splunk is running
      become_user: "{{ splunk_user }}"
      ansible.builtin.command: "{{ splunk_home }}/bin/splunk status"
      register: splunk_status
      changed_when: false
      failed_when: "'splunkd is running' not in splunk_status.stdout"
