---
- name: Mock install and start Splunk service (Exam-safe)
  hosts: splunk
  become: true
  gather_facts: false

  vars:
    splunk_user: splunk
    splunk_group: splunk
    splunk_home: /opt/splunk

  tasks:
    - name: Create splunk group
      group:
        name: "{{ splunk_group }}"
        state: present

    - name: Create splunk user
      user:
        name: "{{ splunk_user }}"
        group: "{{ splunk_group }}"
        shell: /bin/bash
        create_home: true

    - name: Create splunk directory structure
      file:
        path: "{{ splunk_home }}/bin"
        state: directory
        owner: "{{ splunk_user }}"
        group: "{{ splunk_group }}"
        recurse: true

    - name: Create mock splunk binary
      copy:
        dest: "{{ splunk_home }}/bin/splunk"
        owner: "{{ splunk_user }}"
        group: "{{ splunk_group }}"
        mode: '0755'
        content: |
          #!/bin/bash
          if [ "$1" = "status" ]; then
            echo "splunkd is running"
          elif [ "$1" = "version" ]; then
            echo "Splunk 9.x (mock)"
          else
            echo "Splunk mock command"
          fi

    - name: Verify mock Splunk status
      become_user: splunk
      command: "{{ splunk_home }}/bin/splunk status"
      register: splunk_status
      changed_when: false
      failed_when: "'splunkd is running' not in splunk_status.stdout"
