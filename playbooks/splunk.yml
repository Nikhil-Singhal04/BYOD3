---
- name: Install and start Splunk Enterprise (Package Based)
  hosts: splunk
  become: yes
  gather_facts: yes

  vars:
    splunk_version: "9.1.1"
    splunk_build: "64e843ea36b1"
    splunk_pkg: "/tmp/splunk.deb"
    splunk_home: "/opt/splunk"
    splunk_web_port: 8000

  pre_tasks:
    - name: Fail if splunk_admin_password not provided
      ansible.builtin.assert:
        that:
          - splunk_admin_password is defined
          - splunk_admin_password | length >= 8
        fail_msg: "Provide -e splunk_admin_password=<password>"

  tasks:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required packages
      ansible.builtin.apt:
        name:
          - wget
          - curl
        state: present

    - name: Download Splunk DEB package
      ansible.builtin.get_url:
        url: "https://download.splunk.com/products/splunk/releases/{{ splunk_version }}/linux/splunk-{{ splunk_version }}-{{ splunk_build }}-linux-2.6-amd64.deb"
        dest: "{{ splunk_pkg }}"
        mode: "0644"

    - name: Install Splunk
      ansible.builtin.apt:
        deb: "{{ splunk_pkg }}"
        state: present

    - name: Seed admin password (first run only)
      ansible.builtin.copy:
        dest: "{{ splunk_home }}/etc/system/local/user-seed.conf"
        content: |
          [user_info]
          USERNAME = admin
          PASSWORD = {{ splunk_admin_password }}
        owner: splunk
        group: splunk
        mode: "0600"
      args:
        creates: "{{ splunk_home }}/etc/system/local/user-seed.conf"

    - name: Start Splunk and accept license (only once)
      ansible.builtin.command: >
        {{ splunk_home }}/bin/splunk start
        --accept-license
        --answer-yes
        --no-prompt
      args:
        creates: "{{ splunk_home }}/var/run/splunk/splunkd.pid"

    - name: Enable Splunk at boot
      ansible.builtin.command: >
        {{ splunk_home }}/bin/splunk enable boot-start
        --accept-license
        --answer-yes
        --no-prompt
      args:
        creates: "/etc/init.d/splunk"

    - name: Ensure Splunk service is running
      ansible.builtin.command: "{{ splunk_home }}/bin/splunk status"
      register: splunk_status
      changed_when: false
      failed_when: "'splunkd is running' not in splunk_status.stdout"

    - name: Wait for Splunk Web port to open
      ansible.builtin.wait_for:
        host: "127.0.0.1"
        port: "{{ splunk_web_port }}"
        delay: 10
        timeout: 300
