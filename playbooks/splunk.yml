---
- name: Install and start Splunk Enterprise
  hosts: splunk
  become: true
  gather_facts: true

  vars:
    splunk_version: "9.0.5"
    splunk_deb_url: "https://download.splunk.com/products/splunk/releases/{{ splunk_version }}/linux/splunk-{{ splunk_version }}-4e7b5e2a9f15-linux-2.6-amd64.deb"
    splunk_home: "/opt/splunk"
    splunk_user: "splunk"
    splunk_group: "splunk"

  pre_tasks:
    - name: Fail if splunk_admin_password not provided
      ansible.builtin.assert:
        that:
          - splunk_admin_password is defined
          - splunk_admin_password | length >= 8
        fail_msg: "Provide -e splunk_admin_password=<password> (min 8 chars)."

  tasks:
    - name: Ensure prerequisite packages are present (Debian)
      when: ansible_os_family == 'Debian'
      ansible.builtin.apt:
        name:
          - wget
          - curl
        state: present
        update_cache: true

    - name: Ensure splunk group exists
      ansible.builtin.group:
        name: "{{ splunk_group }}"
        state: present

    - name: Ensure splunk user exists
      ansible.builtin.user:
        name: "{{ splunk_user }}"
        group: "{{ splunk_group }}"
        shell: /bin/bash
        create_home: true
        system: true

    - name: Download Splunk .deb package
      ansible.builtin.get_url:
        url: "{{ splunk_deb_url }}"
        dest: "/tmp/splunk.deb"
        mode: '0644'

    - name: Install Splunk
      ansible.builtin.apt:
        deb: "/tmp/splunk.deb"
        state: present

    - name: Change Splunk ownership
      ansible.builtin.file:
        path: "{{ splunk_home }}"
        owner: "{{ splunk_user }}"
        group: "{{ splunk_group }}"
        recurse: true

    - name: Start Splunk and accept license
      ansible.builtin.command:
        cmd: >
          {{ splunk_home }}/bin/splunk start
          --accept-license
          --answer-yes
          --no-prompt
          --seed-passwd {{ splunk_admin_password }}
      become_user: "{{ splunk_user }}"
      register: splunk_start
      changed_when: "'Started' in (splunk_start.stdout + splunk_start.stderr)"

    - name: Enable Splunk boot-start (systemd)
      ansible.builtin.command:
        cmd: "{{ splunk_home }}/bin/splunk enable boot-start -user {{ splunk_user }} --accept-license --answer-yes --no-prompt"
      register: splunk_boot
      changed_when: "'installed' in (splunk_boot.stdout + splunk_boot.stderr)"
      failed_when: false

    - name: Verify Splunk is running
      ansible.builtin.command:
        cmd: "{{ splunk_home }}/bin/splunk status"
      become_user: "{{ splunk_user }}"
      register: splunk_sta_
