---
- name: Test Splunk service and reachability
  hosts: splunk
  become: true
  gather_facts: false

  vars:
    splunk_container_name: "splunk"
    splunk_web_port: 8000

  tasks:
    - name: Verify Splunk container is running
      ansible.builtin.shell: "docker inspect -f '{% raw %}{{.State.Running}}{% endraw %}' {{ splunk_container_name }}"
      register: splunk_running
      changed_when: false
      failed_when: "splunk_running.stdout | trim != 'true'"

    - name: Wait for Splunk Web port to be reachable from controller
      ansible.builtin.wait_for:
        host: "{{ inventory_hostname }}"
        port: "{{ splunk_web_port }}"
        timeout: 240
      delegate_to: localhost
      become: false

    - name: Verify Splunk Web responds
      ansible.builtin.uri:
        url: "http://{{ inventory_hostname }}:{{ splunk_web_port }}/en-US/account/login"
        method: GET
        status_code:
          - 200
          - 303
        return_content: false
      delegate_to: localhost
      become: false
