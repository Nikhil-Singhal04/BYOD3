---
- name: Test Splunk service and reachability
  hosts: splunk
  become: true
  gather_facts: true

  vars:
    splunk_home: "/opt/splunk"

  tasks:
    - name: Check Splunk service status command
      become_user: splunk
      ansible.builtin.command:
        cmd: "{{ splunk_home }}/bin/splunk status"
      register: splunk_status
      changed_when: false
      failed_when: "'splunkd is running' not in splunk_status.stdout"

    - name: Wait for Splunk Web port to be reachable from controller
      ansible.builtin.wait_for:
        host: "{{ inventory_hostname }}"
        port: 8000
        timeout: 180
      delegate_to: localhost
      become: false

    - name: Verify Splunk Web responds
      ansible.builtin.uri:
        url: "http://{{ inventory_hostname }}:8000/en-US/account/login"
        method: GET
        status_code:
          - 200
          - 303
        return_content: false
      delegate_to: localhost
      become: false
